!function(a){var b=function(b){if(this._config={container:null,classes:null,onClick:null,onFocus:null,onInit:null,backTemplate:function(){return""},heightRatio:1},a.extend(this._config,b),null===this._config.container||this._config.container.size()<=0)throw new Error("Element not found");var c=this;this.SPACE_BETWEEN_ELEMENTS=.75,this.FOCUS_TRANSLATION=1,this.FONT_RATIO=22,this.TEMPLATE='<div class="tdvp"><div class="template-element"><div class="front applyHeight"><div class="image"></div><div class="applyHeight"><div class="mirror"></div><div class="shadow"></div></div></div><div class="back applyFont applyHeight"></div></div></div><div class="tdlabel"><div class="label-overflow"></div></div>',this._original=this._config.container,this._templateElement=null,this._vp=null,this._cont=null,this._build(),this._heightRatio=this._config.heightRatio,this._clabel=this._cont.find(".tdlabel"),this._labelOverflow=this._clabel.find(".label-overflow"),this._elements=this._vp.find(".element"),this._elemWidth=null,this._contWidth=null,this._circleStep=null,this._radius=null,this._nElem=null;var d=null;a(window).on("resize.tdGal",function(){d&&clearTimeout(d),d=setTimeout(function(){c._onWinResize()},200)}),this._setDefaultFocus(),this._compileLabels(),this.update(),this._config.onInit&&window.setTimeout(function(){c._config.onInit()})};b.prototype._build=function(){var b=[];this._original.find("li").each(function(){var c=a(this),d=c.find("a"),e=d.attr("href");("javascript:"===e.toLowerCase()||"#"===e)&&(e=null);var f={link:e,image:c.find("img").attr("src"),label:d.attr("title")||c.data("label")};a.extend(f,c.data("properties")),b.push(f)});var c=a(this.TEMPLATE);this._templateElement=c.find(".template-element"),this._cont=a("<div />").attr("class",this._config.classes).addClass("tdgal").html(c);var d=this._original.contents();this._original.html(this._cont),this._original=d,this._vp=this._cont.find(".tdvp:first-child");for(var e=0;e<b.length;e++)this._updateElement(b[e])},b.prototype._updateElement=function(b,c){if(!c){c=this._templateElement.clone();var d=this;c.on("click.tdGal",function(){d._onElementClick(a(this))}),this._vp.append(c)}c.find(".mirror,.image").css({"background-image":"url("+b.image+")"}),b.link?c.addClass("link"):c.removeClass("link"),c.find(".back").html(this._config.backTemplate(b)),c.data("data",b).removeClass("template-element").addClass("element")},b.prototype._setDefaultFocus=function(){this._vp.find(".element.focus").size()<=0&&this._elements.eq(0).addClass("focus")},b.prototype.setElements=function(a){for(var b=a.length,c=0;b>c;c++){var d=this._elements.eq(c);this._updateElement(a[c],d.size()?d:null)}for(var c=b;c<this._nElem;c++)this._elements.eq(c).remove();this._elements=this._vp.find(".element"),this._setDefaultFocus(),this._compileLabels(),this.update()},b.prototype._updateSizes=function(){this._elemWidth=this._elements.first().width(),this._contWidth=this._cont.width();var a=this._elemWidth*this._heightRatio;this._elements.height(a).find(".applyHeight").height(a),this._elements.find(".applyFont").css({"font-size":Math.round(this._elemWidth/this.FONT_RATIO)+"px"}),this._cont.height(a+this._clabel.outerHeight(!0)),this._nElem=this._elements.size();var b=this._nElem<=2?3:this._nElem,c=Math.round(this._elemWidth/2/Math.tan(Math.PI/b)),d=Math.floor(this._contWidth/this._elemWidth);this._radius=Math.round(d*this._elemWidth*this.SPACE_BETWEEN_ELEMENTS/2/Math.tan(Math.PI/b)),this._circleStep=c/this._radius*(360/b);var e=this._labelOverflow.find(".text");e.width(this._contWidth),this._labelOverflow.width(e.size()*this._contWidth)},b.prototype._calculate=function(){var a=this._radius+this._elemWidth*this.FOCUS_TRANSLATION;this._vp.css({transform:"translateZ(-"+a+"px) translateX("+(this._contWidth/2-this._elemWidth/2)+"px)"});for(var b=0,c=0;c<this._nElem;c++)if(this._elements.eq(c).hasClass("focus")){b=c;break}for(var c=0;b>c;c++)this._elements.eq(c).css({transform:"rotateY(-"+this._circleStep*(b-c)+"deg) translateZ("+this._radius+"px) rotateY(60deg)"});this._elements.eq(b).css({transform:"rotateY(0deg) translateZ("+a+"px)"});for(var c=b+1;c<this._nElem;c++)this._elements.eq(c).css({transform:"rotateY("+this._circleStep*(c-b)+"deg) translateZ("+this._radius+"px) rotateY(-60deg)"})},b.prototype.update=function(){this._updateSizes(),this._calculate()},b.prototype._compileLabels=function(){for(var b=this._clabel.find(".text"),c=b.size()-1,d=this._elements.size(),e=0;d>e;e++){var f=null;e>c?(f=a('<div class="text" />'),this._labelOverflow.append(f)):f=b.eq(e);var g=this._elements.eq(e).data("data").label;!g||g.length<=0?f.html("&nbsp;"):f.text(g)}for(var e=d;c>=e;e++)b.eq(e).remove()},b.prototype._displayTag=function(a){this._labelOverflow.css({transform:"translateX(-"+this._contWidth*a+"px)"})},b.prototype._onElementClick=function(a){var b=a.data("data");if(a.hasClass("focus"))return void(this._config.onClick&&b.link&&this._config.onClick(b,this._elements.index(a)));this._elements.removeClass("focus"),a.addClass("focus"),this._calculate();var c=this._elements.index(a);this._displayTag(c),this._config.onFocus&&this._config.onFocus(b,c)},b.prototype.next=function(){var a=this._vp.find(".focus"),b=a.next(".element");b.size()>0?this._onElementClick(b):this._onElementClick(this._elements.first())},b.prototype.prev=function(){var a=this._vp.find(".focus"),b=a.prev(".element");b.size()>0?this._onElementClick(b):this._onElementClick(this._elements.last())},b.prototype.focus=function(a){a>=this._nElem?a=0:0>a&&(a=this._nElem-1),this._onElementClick(this._elements.eq(a))},b.prototype.count=function(){return this._nElem},b.prototype.destroy=function(){this._elements.off("click.tdGal"),this._cont.replaceWith(this._original),this._original=null,this._vp=null,this._cont=null,this._clabel=null,this._labelOverflow=null,this._elements=null,this._templateElement=null,this._config=null,a(window).off("resize.tdGal")},b.prototype._onWinResize=function(){this._updateSizes(),this._calculate()},a.fn.tdGal=function(c,d){if("string"==typeof c&&"count"==c){var e=a(this).first().data("__tdgal");if(!e)throw new Error("Tdgal instance not found");return e.count()}return this.each(function(){var e=a(this),f=a(this).data("__tdgal");if("object"==typeof c||"undefined"==typeof c){if(f)throw new Error("TdGal already created");return c||(c={}),c.container=a(this),void e.data("__tdgal",new b(c))}if("string"==typeof c&&f)switch(c.toLowerCase()){case"destroy":return e.data("__tdgal",null),void f.destroy();case"prev":return void f.prev();case"next":return void f.next();case"update":return void f.update();case"focus":return void f.focus(d);case"elements":return void f.setElements(d);default:throw Error("Cannot found method "+c)}throw new Error("Tdgal instance not found")})}}(jQuery),function(a,b){"undefined"!=typeof module&&module.exports?"undefined"==typeof angular?module.exports=b(require("angular")):module.exports=b(angular):"function"==typeof define&&define.amd?define(["angular"],b):b(a.angular)}(this,function(a){var b=a.module("tdGal",[]);b.directive("tdGalBackface",["$controller",function(){return{restrict:"E",templateUrl:function(a,b){return b.templateUrl}}}]),b.directive("tdGal",["$controller","$compile","$rootScope",function(a,b,c){return{restrict:"E",replace:!1,scope:{data:"=",index:"="},link:function(a,d,e,f){var g=e.templateUrl;a.localIndex=a.index;var h={heightRatio:a.$eval(e.heightRatio),classes:e["class"],backTemplate:function(c){if(!g)return"";var d=document.createElement("td-gal-backface");d.setAttribute("template-url",g);var e=a.$new();return e.data=c,b(d)(e),d},onClick:function(b){a.$emit("tdgal-click",b)},onFocus:function(b,d){a.index=a.localIndex=d,a.$$phase||c.$$phase||a.$apply(),a.$emit("tdgal-focus",b)},onInit:function(){a.index&&d.tdGal("focus",a.index)}};(!h.heightRatio||h.heightRatio<=0)&&delete h.heightRatio,(!h.classes||h.classes<=0)&&delete h.classes,d.tdGal(h);var i=a.$watch("index",function(b){a.localIndex!=b&&d.tdGal("focus",b)}),j=a.$watch("data",function(a){d.tdGal("elements",a)});a.$on("$destroy",function(){d.tdGal("destroy"),j(),i()})}}}])});